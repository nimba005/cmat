<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🌍 CMAT Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

  <!-- NAVIGATION BAR -->
  <nav class="navbar">
    <div class="nav-left">
      <h2>🌍 CMAT</h2>
    </div>
    <div class="nav-right">
      <a href="/" class="nav-link">Home</a>
      <a href="/about" class="nav-link">About</a>
      {% if session.get("user") %}
        <a href="/upload" class="nav-link">Upload Doc</a>
        <a href="/survey" class="nav-link">Survey</a>
        <a href="/logout" class="nav-link">Logout</a>
      {% else %}
        <a href="/login" class="nav-link">Login</a>
      {% endif %}
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <div class="page-container">

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if page == "home" %}
      <div class="top-header">
        <h2>🌍 Welcome to CMAT Dashboard</h2>
        <p>AI-enabled tool for tracking Zambia’s climate finance and policies.</p>
      </div>
      <div class="section">
        <h3>📌 Overview</h3>
        <p>
          The Climate Monitoring & Accountability Tool (CMAT) strengthens parliamentary oversight by 
          tracking climate budgets, programmes, and indicators. Navigate through the menu above to 
          explore more.
        </p>
      </div>

    {% elif page == "about" %}
      <div class="section">
        <h2>ℹ️ About CMAT</h2>
        <p>
          CMAT is an AI-enabled oversight tool for Zambia’s National Assembly. 
          It tracks budgets, laws, and climate projects to ensure transparency 
          and accountability in climate governance.
        </p>
        <ul>
          <li>📜 Developed under NAZ Standing Orders (2024)</li>
          <li>🎯 Supports tracking of climate-related budgets & policies</li>
          <li>🌍 Aligns with Paris Agreement & Zambia’s NDCs</li>
        </ul>
      </div>

    {% elif page == "upload" %}
      <div class="section">
        <h2>📑 Upload Document</h2>
        <p>Upload a budget or climate policy PDF. The AI will extract and analyze key allocations.</p>
        <form id="uploadForm" enctype="multipart/form-data">
          <input type="file" name="pdf" accept="application/pdf" required>
          <button type="submit">Upload & Analyze</button>
        </form>
      </div>

      <div class="section">
        <h3>Extracted Budget Info</h3>
        <pre id="budgetInfo"></pre>
      </div>

      <div class="section">
        <h3>Agriculture Budget Chart</h3>
        <div id="agriChart"></div>
      </div>

      <div class="section">
        <h3>Climate Programmes</h3>
        <div id="climateChart"></div>
      </div>

      <script>
        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const res = await fetch("/upload", { method: "POST", body: formData });
          const data = await res.json();

          document.getElementById("budgetInfo").innerText = JSON.stringify(data.budget_info, null, 2);

          if (data.agriculture) {
            const x = data.agriculture.map(d => d.Programme);
            const y = data.agriculture.map(d => d["2024"]);
            Plotly.newPlot("agriChart", [{
              x, y, type: "bar", text: y, textposition: "outside"
            }], { title: "Agriculture Budget 2024" });
          }

          if (data.climate_programmes) {
            const x = data.climate_programmes.map(d => d.Programme);
            const y = data.climate_programmes.map(d => d["2024"]);
            Plotly.newPlot("climateChart", [{
              x, y, type: "bar", text: y, textposition: "outside"
            }], { title: "Climate Programmes 2024" });
          }
        });
      </script>

    {% elif page == "survey" %}
      <div class="section">
        <h2>📝 CMAT Survey</h2>
        <p>Manually enter or review extracted indicator values here. (Form integration coming soon)</p>
      </div>

    {% elif page == "login" %}
      <div class="section">
        <h2>🔐 Login</h2>
        <form method="POST" action="/login">
          <input type="text" name="username" placeholder="Username" required>
          <input type="password" name="password" placeholder="Password" required>
          <button type="submit">Login</button>
        </form>
        <p>Don’t have an account? <a href="/signup">Sign up</a></p>
      </div>

    {% elif page == "signup" %}
      <div class="section">
        <h2>📝 Signup</h2>
        <form method="POST" action="/signup">
          <input type="text" name="username" placeholder="Username" required>
          <input type="password" name="password" placeholder="Password" required>
          <button type="submit">Signup</button>
        </form>
        <p>Already have an account? <a href="/login">Login</a></p>
      </div>
    {% endif %}

  </div>

  <!-- FOOTER -->
  <div class="footer">
    <p>© 2025 CMAT | Built for Climate Finance Oversight</p>
    <p><a href="mailto:zambiaparliament.com">Contact Support</a></p>
  </div>

</body>
</html>
