<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üåç CMAT Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

  <!-- NAVIGATION BAR -->
  <nav class="navbar">
    <div class="nav-left">
      <h2>
        <img src="{{ url_for('static', filename='images/gv_zambia.png') }}" 
            alt="National Assembly Logo" 
            class="logo">
        NATIONAL ASSEMBLY OF ZAMBIA
      </h2>
    </div>
    <div class="nav-right">
      <a href="/" class="nav-link">Home</a>

      {% if session.get("user") %}
        <a href="/calendar" class="nav-link">Calendar</a>
        <a href="/budget" class="nav-link">Budget</a>
      {% endif %}

      <a href="/gis-projects" class="nav-link">GIS Projects</a>
      <a href="/atlas" class="nav-link">Atlas</a>

      {% if session.get("user") %}
        {% if session.get("role") == "admin" %}
          <a href="/admin/projects" class="nav-link">Manage Projects</a>
          <a href="/admin/news" class="nav-link">Manage News</a>
        {% endif %}
        <a href="/logout" class="nav-link">Logout</a>
      {% else %}
        <a href="/login" class="nav-link">Login</a>
      {% endif %}
    </div>
  </nav>


  <!-- PAGE CONTENT -->
  <div class="page-container">

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if page == "home" %}
      <div class="top-header">
        <h2>üåç Welcome to CMAT Dashboard</h2>
        <p>AI-enabled tool for tracking Zambia‚Äôs climate finance and policies.</p>
      </div>
      <div class="section">
        <h3>üìå Overview</h3>
        <p>
          The Climate Monitoring & Accountability Tool (CMAT) strengthens parliamentary oversight by 
          tracking climate budgets, programmes, and indicators. Navigate through the menu above to 
          explore more.
        </p>
      </div>

      
      <!-- === About CMAT (Home) ‚Äî REPLACE THIS WHOLE BLOCK === -->
      <div class="section about-cmat">
        <div class="about-header">
          <div>
            <h2>‚ÑπÔ∏è About CMAT</h2>
            <p class="subtle">
              The <strong>Climate Monitoring &amp; Accountability Tool (CMAT)</strong> is an AI-enabled
              platform by the <strong>National Assembly of Zambia (NAZ)</strong>, developed with
              <strong>AGNES</strong>, to help Parliament and stakeholders track climate policy, budgets,
              and project implementation.
            </p>
          </div>
          <div class="badge">v1.0 ‚Ä¢ Public Beta</div>
        </div>

        <!-- Key context & objectives -->
        <div class="grid-2">
          <div class="card-lite">
            <h3>üìú Background &amp; Mandate</h3>
            <ul class="meta-list">
              <li><strong>Standing Orders (2024)</strong> and the <strong>National Planning &amp; Budgeting Act No. 1 of 2020</strong> guide oversight.</li>
              <li>Focus on the <strong>Ministry of Green Economy &amp; Environment</strong> and cross-government climate spending.</li>
              <li>Alignment with <strong>Paris Agreement</strong>, <strong>NDCs</strong>, and national strategies.</li>
            </ul>
          </div>

          <div class="card-lite">
            <h3>üéØ What CMAT Delivers</h3>
            <ul class="meta-list">
              <li><strong>Budget analytics</strong> (upload PDFs + manual inputs) for rapid insights.</li>
              <li><strong>Policy &amp; legislation tracking</strong> with configurable indicators.</li>
              <li><strong>GIS verification</strong> of projects with location evidence.</li>
              <li><strong>Parliamentary calendar</strong> integration for timely scrutiny.</li>
            </ul>
          </div>
        </div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-value">{{ news|length if news else 0 }}</div>
            <div class="kpi-label">News &amp; Briefs</div>
          </div>
          <div class="kpi">
            <div class="kpi-value">{{ (projects|length) if projects is defined else 0 }}</div>
            <div class="kpi-label">GIS-Mapped Projects</div>
          </div>
          <div class="kpi">
            <div class="kpi-value">5</div>
            <div class="kpi-label">Core Indicators</div>
          </div>
          <div class="kpi">
            <div class="kpi-value">24/7</div>
            <div class="kpi-label">AI Assistance</div>
          </div>
        </div>

        <!-- Collapsible indicator groups -->
        <div class="grid-2">
          <details class="card-lite" open>
            <summary>üìå Legislative Indicators</summary>
            <ul class="meta-list">
              <li>Climate-related laws enacted &amp; quality of provisions</li>
              <li>Implementation timeliness &amp; compliance</li>
              <li>Oversight activities &amp; follow-up actions</li>
            </ul>
          </details>

          <details class="card-lite" open>
            <summary>üí∞ Financial Indicators</summary>
            <ul class="meta-list">
              <li>Total public investment in climate initiatives</li>
              <li>% of budget for adaptation/mitigation</li>
              <li>Private finance leveraged &amp; co-financing</li>
            </ul>
          </details>
        </div>

        <!-- Primary CTAs (routes already exist in your app) -->
        <div class="cta-row">
          <a href="/budget" class="btn btn-primary">Open Budget Workspace</a>
          <a href="/gis-projects" class="btn">Browse GIS Projects</a>
          <a href="/calendar" class="btn">View Legislative Calendar</a>
        </div>

        <!-- Reference documents (your existing cards, restyled) -->
        <h3 class="docs-title">Reference Documents</h3>
        <div class="docs-grid">
          <a href="{{ url_for('download_file', filename='Updated-Final-Zambia-NPC-IP_Sent-to-CIF-by-MGEE_27112024.pdf') }}" target="_blank" class="doc-card">
            <div class="icon">üåç</div>
            <h3>Climate Insights</h3>
            <p>Latest analysis and national submissions related to climate investment planning.</p>
          </a>

          <a href="{{ url_for('download_file', filename='Report of the Committee on Agriculture, Lands and Natural Resources on Carbon Markets and Trading in Zambia.pdf') }}" target="_blank" class="doc-card">
            <div class="icon">üìö</div>
            <h3>Parliamentary Reports</h3>
            <p>Committee positions on carbon markets, trading, and oversight learnings.</p>
          </a>

          <a href="{{ url_for('download_file', filename='Acts No. 18 for 2024, The Green Economy and Climate Change, pdf.pdf') }}" target="_blank" class="doc-card">
            <div class="icon">üó∫Ô∏è</div>
            <h3>Legal Framework</h3>
            <p>Green Economy &amp; Climate Change Act (No. 18 of 2024) and related statutes.</p>
          </a>
        </div>
      </div>


      <!-- üåç CLIMATE CONTENT SLIDESHOW -->
      <div class="section">
        <h2>üåç Content on Climate Change</h2>
        <p>Explore highlights on climate action, policies, and key events</p>

        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollCarousel(-1)">‚¨ÖÔ∏è</button>
          <div class="carousel" id="climate-carousel">
      
            <a href="{{ url_for('download_file', filename='cop28.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/COP-28.png') }}" alt="COP-28">
              <h3>COP-28</h3>
              <p>Highlights from COP-28 showcasing international commitments.</p>
            </a>

            <a href="{{ url_for('download_file', filename='NATIONAL-GREEN-GROWTH-STRATEGY-2024-2030-6.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/image.png') }}" alt="Climate Finance">
              <h3>Climate Finance</h3>
              <p>Insights on financing climate projects and mobilizing resources.</p>
            </a>

            <a href="{{ url_for('download_file', filename='Updated-Final-Zambia-NPC-IP_Sent-to-CIF-by-MGEE_27112024.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/impact.png') }}" alt="Climate Impact">
              <h3>Climate Change Impact</h3>
              <p>Examining the effects of climate change on communities.</p>
            </a>

            <a href="{{ url_for('download_file', filename='cop29.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/cop29.jpg') }}" alt="COP-29">
              <h3>COP-29</h3>
              <p>Looking ahead to COP-29 and key negotiations.</p>
            </a>

            <a href="{{ url_for('download_file', filename='NATIONAL POLICY ON CLIMATE CHANGE 2016.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/policy.jpg') }}" alt="Policy">
              <h3>Climate Change Policy</h3>
              <p>Understanding Zambia‚Äôs and global climate policies.</p>
            </a>

            <a href="{{ url_for('download_file', filename='agnes.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/AGNES.png') }}" alt="AGNES">
              <h3>Learn about AGNES</h3>
              <p>Discover the role of AGNES in climate negotiations.</p>
            </a>

          </div>
          <button class="carousel-btn next" onclick="scrollCarousel(1)">‚û°Ô∏è</button>
        </div>
      </div>

      <script>
        const carousel = document.getElementById("climate-carousel");
        const scrollAmount = 320; // card width + gap

        // Clone all cards and append to the carousel (for seamless loop)
        const cards = Array.from(carousel.children);
        cards.forEach(card => {
          const clone = card.cloneNode(true);
          carousel.appendChild(clone);
        });

        function scrollCarousel(direction = 1) {
          carousel.scrollBy({ left: direction * scrollAmount, behavior: "smooth" });

          // If we've scrolled past half the content (original set), reset back
          if (carousel.scrollLeft >= carousel.scrollWidth / 2) {
          carousel.scrollTo({ left: 0, behavior: "auto" });
          }
        }

        // Auto-scroll every 3s (you can change speed)
        setInterval(scrollCarousel, 3000);
      </script>


      <!-- NEW: News & Articles Section -->
      <div class="section">
        <h2>üì∞ News & Articles</h2>
        <p>Always up to date with our latest News and Articles</p>

        <div class="news-grid">
          {% for n in news %}
            <div class="news-card">
              {% if n.image %}
                <img src="{{ url_for('static', filename=n.image) }}" alt="News Image">
              {% endif %}
              <h3>{{ n.title }}</h3>
              <small>Posted by {{ n.posted_by }} ‚Ä¢ {{ n.created_at }}</small>
              <p>{{ n.content[:150] }}...</p>
              <a href="{{ url_for('news_detail', news_id=n.id) }}">Read more ‚Üí</a>
            </div>
          {% endfor %}
        </div>
      </div>



      <!-- üìä FINANCIAL DOCUMENTS SECTION -->
      <div class="section">
        <h2>üìä Financial Reports by Year</h2>
        <p>Browse annual financial documents and reports</p>

        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollFinancial(-1)">‚¨ÖÔ∏è</button>
          <div class="carousel" id="financial-carousel">

            <!-- Example yearly docs -->
            <a href="{{ url_for('download_file', filename='2016Budget.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2016.jpg') }}" alt="Financial 2016">
              <h3>Financial Report 2016</h3>
              <p>Annual budget & expenditure summary</p>
            </a>

            <a href="{{ url_for('download_file', filename='Yellow Book 2017.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2017.jpg') }}" alt="Financial 2017">
              <h3>Financial Report 2017</h3>
              <p>Annual budget & expenditure summary</p>
            </a>

            <a href="{{ url_for('download_file', filename='2021 Yellow Book.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2021.jpg') }}" alt="Financial 2021">
              <h3>Financial Report 2021</h3>
              <p>Annual budget & expenditure summary</p>
            </a>

            <a href="{{ url_for('download_file', filename='2022 YELLOW BOOK.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2022.jpg') }}" alt="Financial 2022">
              <h3>Financial Report 2022</h3>
              <p>Climate finance allocations and spending</p>
            </a>

            <a href="{{ url_for('download_file', filename='07 Main Report Budget 2023.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2023.jpg') }}" alt="Financial 2023">
              <h3>Financial Report 2023</h3>
              <p>Parliamentary oversight and analysis</p>
            </a>

            <a href="{{ url_for('download_file', filename='2024_20National_20Budget_20OBB.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2024.jpg') }}" alt="Financial 2024">
              <h3>Financial Report 2024</h3>
              <p>Detailed expenditure and projections</p>
            </a>

            <a href="{{ url_for('download_file', filename='2025_20APPROVED_20BUDGET.pdf') }}" target="_blank" class="carousel-card">
              <img src="{{ url_for('static', filename='images/finance2025.jpg') }}" alt="Financial 2025">
              <h3>Financial Report 2025</h3>
              <p>Detailed expenditure and projections</p>
            </a>

          </div>
          <button class="carousel-btn next" onclick="scrollFinancial(1)">‚û°Ô∏è</button>
        </div>
      </div>

      <script>
        const financialCarousel = document.getElementById("financial-carousel");
        const financialScroll = 320; // card width + gap

        // Clone for seamless loop
        const financialCards = Array.from(financialCarousel.children);
        financialCards.forEach(card => {
          const clone = card.cloneNode(true);
          financialCarousel.appendChild(clone);
        });

        function scrollFinancial(direction = 1) {
          financialCarousel.scrollBy({ left: direction * financialScroll, behavior: "smooth" });

          // Reset loop
          if (financialCarousel.scrollLeft >= financialCarousel.scrollWidth / 2) {
            financialCarousel.scrollTo({ left: 0, behavior: "auto" });
          }
        }

        // Auto-scroll every 4s
        setInterval(scrollFinancial, 4000);
      </script>

      <!-- ü§ñ Floating Chatbot Widget -->
      <div id="chatbot-widget">
        <button id="chatbot-toggle">üí¨</button>
        <div id="chatbot-box" class="chatbot-box hidden">
          <div id="chatbot-header">
            <span>CMAT Assistant</span>
            <button id="chatbot-close">‚úñ</button>
          </div>
          <div id="chatbot-messages"></div>
          <div class="chatbot-input">
            <input type="text" id="chatbot-user-input" placeholder="Type your question...">
            <button onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
      <script>
        // Toggle chatbot
        const chatbotToggle = document.getElementById("chatbot-toggle");
        const chatbotBox = document.getElementById("chatbot-box");
        const chatbotClose = document.getElementById("chatbot-close");

        chatbotToggle.addEventListener("click", () => {
          chatbotBox.classList.toggle("hidden");
        });
        chatbotClose.addEventListener("click", () => {
          chatbotBox.classList.add("hidden");
        });

        async function sendMessage() {
          const input = document.getElementById("chatbot-user-input");
          const msg = input.value.trim();
          if (!msg) return;

          const messagesDiv = document.getElementById("chatbot-messages");
          messagesDiv.innerHTML += `<div class="message user">${msg}</div>`;
          input.value = "";
          messagesDiv.scrollTop = messagesDiv.scrollHeight;

          try {
            const response = await fetch("/api/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: msg })
            });
            const data = await response.json();

            if (data.reply) {
              messagesDiv.innerHTML += `<div class="message bot">${data.reply}</div>`;
            } else {
              messagesDiv.innerHTML += `<div class="message bot">‚ö†Ô∏è Error: ${data.error}</div>`;
            }
          } catch (err) {
            messagesDiv.innerHTML += `<div class="message bot">‚ö†Ô∏è Server error.</div>`;
          }

          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      </script>



    {% elif page == "gis_projects" %}
      <div class="section">
        <h2>üó∫Ô∏è GIS-Enabled National Climate Projects</h2>
        <p>Explore featured projects and verify locations via the embedded maps.</p>

        <div class="projects-container">
          {% for project in projects %}
            <div class="project-card">
              <img src="{{ url_for('static', filename=project.image or 'images/default.jpg') }}" 
                  alt="{{ project.title }}" 
                  class="project-img">

              <div class="project-details">
                <h3>{{ project.title }}</h3>
                <p>{{ project.description }}</p>
                <p><strong>Start:</strong> {{ project.start_date }}</p>
                <p><strong>End:</strong> {{ project.end_date }}</p>
                <p><strong>Status:</strong> {{ project.status }}</p>
                <p><strong>Budget:</strong> ${{ "{:,.2f}".format(project.budget) }}</p>
                <p><strong>Completion:</strong> {{ project.completion_percentage }}%</p>
              </div>

              <div id="map-{{ project.id }}" class="project-map"></div>
            </div>
          {% endfor %}
        </div>
      </div>

      <script>
        const projectsGIS = {{ projects|tojson }};
        projectsGIS.forEach(p => {
          if (p.latitude && p.longitude) {
            const map = L.map(`map-${p.id}`).setView([p.latitude, p.longitude], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker([p.latitude, p.longitude]).addTo(map)
              .bindPopup(`<b>${p.title}</b><br>${p.description}`);
          } else {
            console.warn(`Project ${p.id} is missing location data.`);
          }
        });
      </script>


    {% elif page == "admin_projects" %}
      <div class="section">
        <h2>üìä Manage Projects</h2>

        <!-- Add Project Form -->
        <form method="POST" action="/admin/projects/add" enctype="multipart/form-data">
          <input type="text" name="title" placeholder="Project Title" required>
          <textarea name="description" placeholder="Description"></textarea>
          <!-- Image Upload -->
          <input type="file" name="image" accept="image/*" required>
          <input type="number" step="any" name="latitude" placeholder="Latitude">
          <input type="number" step="any" name="longitude" placeholder="Longitude">
          <input type="date" name="start_date">
          <input type="date" name="end_date">
          <input type="number" step="any" name="budget" placeholder="Budget">
          <input type="text" name="status" placeholder="Status">
          <input type="number" step="any" name="completion_percentage" placeholder="% Complete">
          <button type="submit">‚ûï Add Project</button>
        </form>

        <!-- Existing Projects -->
        <h3>Existing Projects</h3>
        <table border="1">
          <tr>
            <th>Title</th>
            <th>Budget</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
          {% for p in projects %}
          <tr>
            <td>{{ p.title }}</td>
            <td>{{ p.budget }}</td>
            <td>{{ p.status }}</td>
            <td>
              <!-- Update Form -->
              <form method="POST" action="/admin/projects/update/{{ p.id }}" style="display:inline;">
                <input type="text" name="title" value="{{ p.title }}">
                <input type="number" step="any" name="budget" value="{{ p.budget }}">
                <input type="text" name="status" value="{{ p.status }}">
                <button type="submit">‚úèÔ∏è Update</button>
              </form>

              <!-- Delete -->
              <form method="POST" action="/admin/projects/delete/{{ p.id }}" style="display:inline;">
                <button type="submit">üóëÔ∏è Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

    {% elif page == "admin_news" %}
      <div class="section">
        <h2>üì∞ Manage News</h2>

        <!-- Add News Form -->
        <form method="POST" action="/admin/news/add" enctype="multipart/form-data">
          <input type="text" name="title" placeholder="News Title" required>
          <textarea name="content" placeholder="News content"></textarea>
          <input type="file" name="image" accept="image/*">
          <button type="submit">‚ûï Post News</button>
        </form>

        <!-- Existing News -->
        <h3>Existing News</h3>
        <ul>
          {% for n in news %}
            <li>
              <!-- Title clickable -->
              <a href="{{ url_for('news_detail', news_id=n.id) }}">
                <strong>{{ n.title }}</strong>
              </a> 
              ({{ n.created_at }})  

              <p>{{ n.content[:200] }}... 
                <a href="{{ url_for('news_detail', news_id=n.id) }}">Read more ‚Üí</a>
              </p>

              {% if n.image %}
                <img src="{{ url_for('static', filename=n.image) }}" width="120">
              {% endif %}

              <form method="POST" action="/admin/news/delete/{{ n.id }}">
                <button type="submit">üóëÔ∏è Delete</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      </div>

    {% elif page == "news_detail" %}
      <div class="section">
        <h2>{{ news.title }}</h2>
        <small>Posted by {{ news.posted_by }} ‚Ä¢ {{ news.created_at }}</small>

        {% if news.image %}
          <img src="{{ url_for('static', filename=news.image) }}" alt="News Image" style="max-width: 400px; margin: 10px 0;">
        {% endif %}

        <p>{{ news.content }}</p>

        <a href="/">‚Üê Back to News</a>
      </div>




    {% elif page == "calendar" %}
      <div class="section">
        <h2>üìÖ Zambia‚Äôs Legislative Calendar</h2>
        <p>Stay updated with Zambia‚Äôs official legislative calendar and track important events.</p>
        <div id="calendar"></div>
      </div>

      <!-- FullCalendar.js Integration -->
      <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const calendarEl = document.getElementById("calendar");

          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            events: "/api/events", // üîó Load events from Flask API
            selectable: true,

            // Add new events
            select: function(info) {
              const title = prompt("Enter Event Title:");
              if (title) {
                fetch("/api/events", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    title: title,
                    start: info.startStr,
                    end: info.endStr
                  })
                })
                .then(res => res.json())
                .then(() => calendar.refetchEvents());
              }
            },
            // Delete existing events
            eventClick: function(info) {
              if (confirm(`Delete event: "${info.event.title}"?`)) {
                fetch(`/api/events/${info.event.id}`, { method: "DELETE" })
                  .then(res => res.json())
                  .then(() => calendar.refetchEvents());
              }
            }
          });

          calendar.render();
        });
      </script>


    {% elif page == "budget" %}
      <div class="section">
        <h2>üíº Budget Workspace</h2>
        <p>Upload financial PDFs for AI extraction and enter manual survey values. Both feed your budget analytics.</p>
      </div>

      <!-- === Upload & Analyze === -->
      <div class="section">
        <h3>üìë Upload and Analyze Financial Document</h3>
        <form id="uploadForm">
          <input type="file" name="pdf" accept="application/pdf" required>
          <button type="submit">Upload & Analyze</button>
        </form>
        <div id="results"></div>
      </div>

      <script>
        document.getElementById("uploadForm").addEventListener("submit", async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          fetch("/upload/analyze", {
            method: "POST",
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              document.getElementById("results").innerHTML = "‚ö†Ô∏è " + data.error;
              return;
            }
            document.getElementById("results").innerHTML = `
              <h3>‚úÖ Analysis Complete</h3>
              <pre>${JSON.stringify(data.graphs || data.raw || data, null, 2)}</pre>
            `;
          })
          .catch(err => {
            console.error(err);
            document.getElementById("results").innerHTML = "‚ö†Ô∏è Error analyzing document.";
          });
        });
      </script>

      <!-- === Manual Survey === -->
      <div class="section">
        <h3>üìù Manual Survey Entry</h3>
        <form id="survey-form" class="survey-grid">
          {% for category, inds in indicators.items() %}
            <h3>{{ category }}</h3>
            {% for ind in inds %}
              <div class="survey-field">
                <label>{{ ind }}</label>
                <input type="number" step="any" name="{{ ind }}"
                      value="{{ survey_data.get(ind, '') }}"
                      class="survey-input">
              </div>
            {% endfor %}
          {% endfor %}
          <button type="submit" class="survey-btn">üíæ Save Survey</button>
        </form>

        <div class="section results-section">
          <h3>üìä Survey Results</h3>
          <div id="surveyChart"></div>
        </div>
      </div>

      <script>
        document.getElementById("survey-form").addEventListener("submit", async function(e) {
          e.preventDefault();
          let data = {};
          new FormData(this).forEach((value, key) => data[key] = parseFloat(value) || null);

          const res = await fetch("/api/survey", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
          });
          const result = await res.json();

          if (result.success) {
            renderCharts(result.results);
          } else {
            alert("‚ùå Failed to save");
          }
        });

        function renderCharts(results) {
          const labels = Object.keys(results || {});
          const values = Object.values(results || {});
          if (!labels.length) return;

          Plotly.newPlot("surveyChart", [{
            x: labels,
            y: values,
            type: "bar",
            text: values,
            textposition: "outside",
            marker: { color: "rgba(54, 162, 235, 0.7)" }
          }], {
            title: "Survey Results",
            xaxis: { title: "Indicators" },
            yaxis: { title: "Values", zeroline: false }
          });
        }
      </script>

    {% elif page == "atlas" %}
      <div class="section">
        <h2>üß≠ Atlas</h2>
        <p>A consolidated, browsable atlas of climate indicators, layers, and documents. (Content coming soon.)</p>
      </div>



    {% elif page == "login" %}
      <div class="section">
        <h2>üîê Login</h2>
        <form method="POST" action="/login">
          <input type="text" name="username" placeholder="Username" required>
          <input type="password" name="password" placeholder="Password" required>
          <button type="submit">Login</button>
        </form>
        <p>Don‚Äôt have an account? <a href="/signup">Sign up</a></p>
      </div>

    {% elif page == "signup" %}
      <div class="section">
        <h2>üìù Signup</h2>
        <form method="POST" action="/signup">
          <input type="text" name="username" placeholder="Username" required>
          <input type="password" name="password" placeholder="Password" required>

          <label for="role">Select Role:</label>
          <select name="role" required>
            <option value="mp">MP</option>
            <option value="senator">Senator</option>
            <option value="admin">Admin</option>
          </select>

          <button type="submit">Signup</button>
        </form>
        <p>Already have an account? <a href="/login">Login</a></p>
      </div>
    {% endif %}

  </div>

  <!-- FOOTER -->
  <div class="footer">
    <p>¬© 2025 CMAT | Built for Climate Finance Oversight</p>
    <p><a href="mailto:zambiaparliament.com">Contact Support</a></p>
  </div>

</body>
</html>
